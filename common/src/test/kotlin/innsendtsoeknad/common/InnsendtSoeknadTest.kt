package innsendtsoeknad.common

import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule
import com.fasterxml.jackson.module.kotlin.jacksonObjectMapper
import com.fasterxml.jackson.module.kotlin.jacksonTypeRef
import com.fasterxml.jackson.module.kotlin.readValue
import io.kotest.matchers.ints.shouldBeExactly
import io.kotest.matchers.shouldBe
import no.nav.etterlatte.libs.common.innsendtsoeknad.barnepensjon.Barnepensjon
import no.nav.etterlatte.libs.common.innsendtsoeknad.common.InnsendtSoeknad
import no.nav.etterlatte.libs.common.innsendtsoeknad.common.SoeknadRequest
import no.nav.etterlatte.libs.common.innsendtsoeknad.common.SoeknadType
import no.nav.etterlatte.libs.common.innsendtsoeknad.omstillingsstoenad.Omstillingsstoenad
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Test

@Suppress("ktlint:standard:max-line-length")
internal class InnsendtSoeknadTest {
    private val mapper =
        jacksonObjectMapper()
            .registerModule(JavaTimeModule())

    @Test
    fun `Deserialisering fungerer som forventet`() {
        val json = """{"soeknader":[{"type":"OMSTILLINGSSTOENAD","spraak":"nb","imageTag":"189h13r89-109j18j38r","template":"omstillingsstoenad_v1","mottattDato":"2022-01-31T00:00:00Z","version":"2","harSamtykket":{"spoersmaal":"Jeg, STOR SNERK, bekrefter at jeg vil gi riktige og fullstendige opplysninger.","svar":true},"innsender":{"type":"INNSENDER","fornavn":{"spoersmaal":"Fornavn","svar":"STOR"},"etternavn":{"spoersmaal":"Etternavn","svar":"SNERK"},"foedselsnummer":{"spoersmaal":"Fødselsnummer","svar":"11057523044"}},"utbetalingsInformasjon":{"spoersmaal":"Ønsker du å motta utbetalingen på norsk eller utenlandsk bankkonto?","svar":{"verdi":"UTENLANDSK","innhold":"Utenlandsk"},"opplysning":{"utenlandskBankNavn":{"spoersmaal":"Bankens navn","svar":{"innhold":"Polski Banki"}},"utenlandskBankAdresse":{"spoersmaal":"Bankens fulle adresse","svar":{"innhold":"Bankiszh Veizhc 13"}},"iban":{"spoersmaal":"IBAN-nummer","svar":{"innhold":"PL10105000997603123456789123"}},"swift":{"spoersmaal":"Bankens S.W.I.F.T (BIC) adresse","svar":{"innhold":"ALBPPLPW"}}}},"soeker":{"type":"GJENLEVENDE_OMS","fornavn":{"spoersmaal":"Fornavn","svar":"TØFF"},"etternavn":{"spoersmaal":"Etternavn","svar":"DAL"},"foedselsnummer":{"spoersmaal":"Fødselsnummer","svar":"14838099980"},"statsborgerskap":{"spoersmaal":"Statsborgerskap","svar":"Norge"},"sivilstatus":{"spoersmaal":"Sivilstatus","svar":"Enke eller enkemann"},"adresse":{"spoersmaal":"Bostedsadresse","svar":"Nøsterudveien 48, 3060 Svelvik"},"kontaktinfo":{"telefonnummer":{"spoersmaal":"Telefonnummer","svar":{"innhold":"+4799999999"}}},"oppholdUtland":{"spoersmaal":"Er du bosatt i Norge?","svar":{"verdi":"JA","innhold":"Ja"},"opplysning":{"oppholderSegIUtlandet":{"spoersmaal":"Har du bodd eller oppholdt deg i utlandet de siste 12 månedene?","svar":{"verdi":"JA","innhold":"Ja"}},"oppholdsland":{"spoersmaal":"Oppgi hvilket land du oppholdt deg i","svar":{"innhold":"Anguilla"}},"oppholdFra":{"spoersmaal":"Fra dato","svar":{"innhold":"2023-12-01"}},"oppholdTil":{"spoersmaal":"Til dato","svar":{"innhold":"2023-12-02"}}}},"nySivilstatus":{"spoersmaal":"Sivilstanden din i dag","svar":{"verdi":"SAMBOERSKAP","innhold":"Samboer"},"opplysning":{"type":"SAMBOER","fornavn":{"spoersmaal":"Fornavn","svar":"Samb"},"etternavn":{"spoersmaal":"Etternavn","svar":"Boer"},"foedselsnummer":{"spoersmaal":"Fødselsnummer","svar":"25027702638"},"fellesBarnEllertidligereGift":{"spoersmaal":"Har eller har dere hatt felles barn, eller har dere tidligere vært gift?","svar":{"verdi":"NEI","innhold":"Nei"}}}},"arbeidOgUtdanning":{"dinSituasjon":{"spoersmaal":"Hva er situasjonen din nå?","svar":[{"verdi":"INGEN","innhold":"Jeg er ikke i arbeid, utdanning eller arbeidssøker"},{"verdi":"UNDER_UTDANNING","innhold":"Jeg tar eller skal ta utdanning"},{"verdi":"ARBEIDSSOEKER","innhold":"Jeg er arbeidssøker"},{"verdi":"TILBUD","innhold":"Jeg har fått tilbud om jobb"},{"verdi":"ETABLERER","innhold":"Jeg etablerer egen virksomhet"},{"verdi":"SELVSTENDIG","innhold":"Jeg er selvstendig næringsdrivende"},{"verdi":"ARBEIDSTAKER","innhold":"Jeg er arbeidstaker og/eller lønnsmottaker som frilanser"}]},"arbeidsforhold":{"spoersmaal":"Om arbeidsforholdet ditt","svar":[{"arbeidsgiver":{"spoersmaal":"Navn på arbeidssted","svar":{"innhold":"Ledelse AS"}},"arbeidsmengde":{"spoersmaal":"Fyll ut stillingsprosenten din","svar":{"innhold":"50 Prosent"}},"ansettelsesforhold":{"spoersmaal":"Hva slags type ansettelsesforhold har du?","svar":{"verdi":"FAST","innhold":"Fast ansatt"}},"endretArbeidssituasjon":{"spoersmaal":"Forventer du endringer i arbeidsforholdet ditt fremover i tid?","svar":{"verdi":"JA","innhold":"Ja"},"opplysning":{"spoersmaal":"Gi en kort beskrivelse av endringene","svar":{"innhold":"Blir CEO"}}}}]},"selvstendig":{"spoersmaal":"Om næringen","svar":[{"firmanavn":{"spoersmaal":"Om næringen","svar":{"innhold":"Selvstengind as"}},"orgnr":{"spoersmaal":"Organisasjonsnummer","svar":{"innhold":"999999999"}},"arbeidsmengde":{"spoersmaal":"Fyll ut arbeidsmengden din","svar":{"innhold":"15 Timer i uka"}},"endretArbeidssituasjon":{"spoersmaal":"Forventer du endringer i arbeidssituasjonen din fremover i tid?","svar":{"verdi":"JA","innhold":"Ja"},"opplysning":{"spoersmaal":"Gi en kort beskrivelse av endringene","svar":{"innhold":"Blir mye overtid"}}}}]},"etablererVirksomhet":{"spoersmaal":"Om virksomheten","svar":{"virksomheten":{"spoersmaal":"Hva heter den nye virksomheten?","svar":{"innhold":"Virksomhet 123"}},"orgnr":{"spoersmaal":"Organisasjonsnummer","svar":{"innhold":"Jeg har ikke organisasjonsnummer"}},"forretningsplan":{"spoersmaal":"Har du en forretningsplan?","svar":{"verdi":"JA","innhold":"Ja"}},"samarbeidMedNav":{"spoersmaal":"Er dette i samarbeid med NAV for at du skal bli selvforsørget?","svar":{"verdi":"JA","innhold":"Ja"}}}},"tilbud":{"spoersmaal":"Om arbeidsforholdet ditt","svar":{"nyttArbeidssted":{"spoersmaal":"Navn på nytt arbeidssted","svar":{"innhold":"Tilbudssted 1"}},"ansettelsesdato":{"spoersmaal":"Når skal du begynne å jobbe?","svar":{"innhold":"2023-12-07"}},"ansettelsesforhold":{"spoersmaal":"Hva slags type ansettelsesforhold skal du ha?","svar":{"verdi":"MIDLERTIDIG","innhold":"Midlertidig ansatt"}},"arbeidsmengde":{"spoersmaal":"Arbeidsmengde","svar":{"innhold":"16 Prosent"}},"harSluttdato":{"spoersmaal":"Har du en sluttdato?","svar":{"verdi":"JA","innhold":"Ja"}},"sluttdato":{"spoersmaal":"Sluttdato","svar":{"innhold":"2023-12-14"}},"aktivitetsplan":{"spoersmaal":"Har du en aktivitetsplan i samarbeid med NAV?","svar":{"verdi":"JA","innhold":"Ja"}}}},"arbeidssoeker":{"spoersmaal":"Om arbeidssøkingen","svar":{"registrertArbeidssoeker":{"spoersmaal":"Er du registrert som arbeidssøker hos NAV?","svar":{"verdi":"JA","innhold":"Ja"}},"aktivitetsplan":{"spoersmaal":"Har du en aktivitetsplan?","svar":{"verdi":"JA","innhold":"Ja"}}}},"utdanning":{"spoersmaal":"Om utdanningen","svar":{"studiested":{"spoersmaal":"Navn på studiested","svar":{"innhold":"NTNU"}},"studie":{"spoersmaal":"Hva studerer du?","svar":{"innhold":"Informatikk"}},"studieform":{"spoersmaal":"Studieform","svar":{"innhold":"Deltid","verdi":"DELTID"}},"studieprosent":{"spoersmaal":"Hva er studieprosenten din?","svar":{"innhold":"99%"}},"startDato":{"spoersmaal":"Fra dato","svar":{"innhold":"2023-12-01"}},"sluttDato":{"spoersmaal":"Til dato","svar":{"innhold":"2023-12-03"}},"godkjentUtdanning":{"spoersmaal":"Er utdanningen godkjent av lånekassen?","svar":{"verdi":"JA","innhold":"Ja"}},"aktivitetsplan":{"spoersmaal":"Har du en aktivitetsplan i samarbeid med NAV?","svar":{"verdi":"JA","innhold":"Ja"}}}},"annenSituasjon":{"spoersmaal":"Annet","svar":{"beskrivelse":{"spoersmaal":"Velg det som beskriver situasjonen din","svar":[{"innhold":"Er syk","verdi":"SYK"},{"innhold":"Annet","verdi":"ANNET"}]},"annet":{"spoersmaal":"Hva er grunnen til endringene?","svar":{"innhold":"Annen situasjon beskrivelse"}}}}},"fullfoertUtdanning":{"spoersmaal":"Hva er din høyeste fullførte utdanning?","svar":[{"verdi":"VIDEREGAAENDE","innhold":"Videregående"},{"verdi":"FAGBREV","innhold":"Fagbrev"}]},"inntektOgPensjon":{"skalGaaAvMedAlderspensjon":{"valg":{"spoersmaal":"Skal du gå av med alderspensjon i år?","svar":{"verdi":"JA","innhold":"Ja"}},"datoForAaGaaAvMedAlderspensjon":{"spoersmaal":"Når planlegger du å ta ut alderspensjon?","svar":{"innhold":"2024-12-03"}}},"inntektFremTilDoedsfallet":{"spoersmaal":"Inntekt frem til dødsfallet","svar":{"arbeidsinntekt":{"spoersmaal":"Arbeidsinntekt og andre utbetalinger","svar":{"innhold":"123"}},"naeringsinntekt":{"inntekt":{"spoersmaal":"Næringsinntekt","svar":{"innhold":"123"}},"erNaeringsinntektOpptjentJevnt":{"valg":{"spoersmaal":"Er næringsinntekten opptjent jevnt i løpet av året?","svar":{"verdi":"NEI","innhold":"Nei"}},"beskrivelse":{"spoersmaal":"Skriv kort om hvordan inntekten varierer gjennom året","svar":{"innhold":"Den varierer veldig"}}}},"afpInntekt":{"inntekt":{"spoersmaal":"Avtalefestet pensjon (AFP) offentlig eller privat","svar":{"innhold":"123"}},"tjenesteordning":{"spoersmaal":"Hvilken tjenesteordning får du AFP fra?","svar":{"innhold":"KLP"}}},"inntektFraUtland":{"spoersmaal":"Alle inntekter fra utland","svar":{"innhold":"123"}},"andreInntekter":{"valg":{"spoersmaal":"Hadde du andre inntekter?","svar":{"verdi":"JA","innhold":"Ja"}},"inntekt":{"spoersmaal":"Andre inntekter","svar":{"innhold":"123"}},"beskrivelse":{"spoersmaal":"Hva slags inntekt var det?","svar":{"innhold":"En hel haug av andre inntekter"}}}}},"forventetInntektIAar":{"spoersmaal":"Forventet årsinntekt i år","svar":{"arbeidsinntekt":{"spoersmaal":"Arbeidsinntekt og andre utbetalinger","svar":{"innhold":"123"}},"naeringsinntekt":{"inntekt":{"spoersmaal":"Næringsinntekt","svar":{"innhold":"123"}},"erNaeringsinntektOpptjentJevnt":{"valg":{"spoersmaal":"Er næringsinntekten opptjent jevnt i løpet av året?","svar":{"verdi":"NEI","innhold":"Nei"}},"beskrivelse":{"spoersmaal":"Skriv kort om hvordan inntekten varierer gjennom året","svar":{"innhold":"Den varierer veldig"}}}},"afpInntekt":{"inntekt":{"spoersmaal":"Avtalefestet pensjon (AFP) offentlig eller privat","svar":{"innhold":"123"}},"tjenesteordning":{"spoersmaal":"Hvilken tjenesteordning får du AFP fra?","svar":{"innhold":"KLP"}}},"inntektFraUtland":{"spoersmaal":"Alle inntekter fra utland","svar":{"innhold":"123"}},"andreInntekter":{"valg":{"spoersmaal":"Har du andre inntekter?","svar":{"verdi":"JA","innhold":"Ja"}},"inntekt":{"spoersmaal":"Andre inntekter","svar":{"innhold":"123"}},"beskrivelse":{"spoersmaal":"Hva slags inntekt er det?","svar":{"innhold":"Masse rare intekter"}}},"noeSomKanPaavirkeInntekten":{"valg":{"spoersmaal":"Er det noe du vet om i dag som kan påvirke inntekten din fremover?","svar":{"verdi":"JA","innhold":"Ja"}},"grunnTilPaavirkelseAvInntekt":{"spoersmaal":"Hva er grunnen til at inntekten endrer seg?","svar":{"verdi":"ANNEN_GRUNN","innhold":"Annen grunn"}},"beskrivelse":{"spoersmaal":"Beskriv endringen","svar":{"innhold":"Endringen endrer seg endelig"}}}}},"forventetInntektTilNesteAar":{"spoersmaal":"Forventet inntekt til neste år","svar":{"arbeidsinntekt":{"spoersmaal":"Arbeidsinntekt og andre utbetalinger","svar":{"innhold":"123"}},"naeringsinntekt":{"inntekt":{"spoersmaal":"Næringsinntekt","svar":{"innhold":"123"}},"erNaeringsinntektOpptjentJevnt":{"valg":{"spoersmaal":"Er næringsinntekten opptjent jevnt i løpet av året?","svar":{"verdi":"NEI","innhold":"Nei"}},"beskrivelse":{"spoersmaal":"Skriv kort om hvordan inntekten varierer gjennom året","svar":{"innhold":"Den varierer veldig"}}}},"afpInntekt":{"inntekt":{"spoersmaal":"Avtalefestet pensjon (AFP) offentlig eller privat","svar":{"innhold":"123"}},"tjenesteordning":{"spoersmaal":"Hvilken tjenesteordning får du AFP fra?","svar":{"innhold":"KLP"}}},"inntektFraUtland":{"spoersmaal":"Alle inntekter fra utland","svar":{"innhold":"123"}},"andreInntekter":{"valg":{"spoersmaal":"Har du andre inntekter?","svar":{"verdi":"JA","innhold":"Ja"}},"inntekt":{"spoersmaal":"Andre inntekter","svar":{"innhold":"123"}},"beskrivelse":{"spoersmaal":"Hva slags inntekt er det?","svar":{"innhold":"Masse rare intekter"}}},"noeSomKanPaavirkeInntekten":{"valg":{"spoersmaal":"Er det noe du vet om i dag som kan påvirke inntekten din fremover?","svar":{"verdi":"JA","innhold":"Ja"}},"grunnTilPaavirkelseAvInntekt":{"spoersmaal":"Hva er grunnen til at inntekten endrer seg?","svar":{"verdi":"ANNEN_GRUNN","innhold":"Annen grunn"}},"beskrivelse":{"spoersmaal":"Beskriv endringen","svar":{"innhold":"Endringen endrer seg endelig"}}}}},"ytelserNAV":{"soektOmYtelse":{"spoersmaal":"Har du søkt om ytelser fra NAV som du ikke har fått svar på?","svar":{"verdi":"JA","innhold":"Ja"}},"soektYtelse":{"spoersmaal":"Hva har du søkt om?","svar":[{"verdi":"FOSTERHJEMSGODTGJOERING","innhold":"Fosterhjemsgodtgjøring"},{"verdi":"KVALIFISERINGSSTOENAD","innhold":"Kvalifiseringsstønad"}]}},"ytelserAndre":{"soektOmYtelse":{"spoersmaal":"Har du søkt om ytelser fra andre enn NAV som du ikke har fått svar på?","svar":{"verdi":"JA","innhold":"Ja"}},"soektYtelse":{"spoersmaal":"Hva har du søkt om?","svar":[{"verdi":"SAERALDERSPENSJON","innhold":"Særalderspensjon"},{"verdi":"ALDERSPENSJON","innhold":"Alderspensjon"}]},"pensjonsordning":{"spoersmaal":"Oppgi hvilken pensjonsordning","svar":{"innhold":"Test pensjonsordning"}}}},"uregistrertEllerVenterBarn":{"spoersmaal":"Venter du barn eller har du barn som ikke er registrert i folkeregisteret?","svar":{"verdi":"NEI","innhold":"Nei"}},"forholdTilAvdoede":{"relasjon":{"spoersmaal":"Relasjonen din til avdøde da dødsfallet skjedde","svar":{"verdi":"SEPARERT","innhold":"Separert"}},"datoForInngaattPartnerskap":{"spoersmaal":"Vi giftet oss","svar":{"innhold":"2022-11-10"}},"fellesBarn":{"spoersmaal":"Har eller har dere hatt felles barn?","svar":{"verdi":"NEI","innhold":"Nei"}}},"omsorgForBarn":{"spoersmaal":"Har du minst 50 prosent omsorg for barn under 18 år på dødsfallstidspunktet?","svar":{"verdi":"JA","innhold":"Ja"}}},"avdoed":{"type":"AVDOED","fornavn":{"spoersmaal":"Fornavn","svar":"Polski"},"etternavn":{"spoersmaal":"Etternavn","svar":"Dødski"},"foedselsnummer":{"spoersmaal":"Fødselsnummer","svar":"26104500284"},"datoForDoedsfallet":{"spoersmaal":"Når skjedde dødsfallet?","svar":{"innhold":"2022-01-04"}},"statsborgerskap":{"spoersmaal":"Statsborgerskap","svar":{"innhold":"Norge"}},"utenlandsopphold":{"spoersmaal":"Bodde eller arbeidet han eller hun i et annet land enn Norge etter fylte 16 år?","svar":{"verdi":"JA","innhold":"Ja"},"opplysning":[{"land":{"spoersmaal":"Land","svar":{"innhold":"Polen"}},"fraDato":{"spoersmaal":"Fra dato (valgfri)","svar":{"innhold":"2001-01-04"}},"tilDato":{"spoersmaal":"Til dato (valgfri)","svar":{"innhold":"2003-01-04"}},"oppholdsType":{"spoersmaal":"Bodd og/eller arbeidet?","svar":[{"verdi":"BODD","innhold":"Bodd"},{"verdi":"ARBEIDET","innhold":"Arbeidet"}]},"medlemFolketrygd":{"spoersmaal":"Var han eller hun medlem av folketrygden under oppholdet?","svar":{"verdi":"NEI","innhold":"Nei"}},"pensjonsutbetaling":{"spoersmaal":"Oppgi eventuell pensjon han eller hun mottok fra dette landet (valgfri)","svar":{"innhold":"50 000 PLN"}}}]},"doedsaarsakSkyldesYrkesskadeEllerYrkessykdom":{"spoersmaal":"Skyldes dødsfallet yrkesskade eller yrkessykdom?","svar":{"verdi":"JA","innhold":"Ja"}}},"barn":[{"type":"BARN","fornavn":{"spoersmaal":"Fornavn","svar":"Barnski"},"etternavn":{"spoersmaal":"Etternavn","svar":"Polski"},"foedselsnummer":{"spoersmaal":"Barnets fødselsnummer / d-nummer","svar":"19040550081"},"statsborgerskap":{"spoersmaal":"Statsborgerskap","svar":"Norge"},"utenlandsAdresse":{"spoersmaal":"Bor barnet i et annet land enn Norge?","svar":{"verdi":"JA","innhold":"Ja"},"opplysning":{"land":{"spoersmaal":"Land","svar":{"innhold":"Polen"}},"adresse":{"spoersmaal":"Adresse i utlandet","svar":{"innhold":"Polski gatski 13"}}}},"foreldre":[{"type":"FORELDER","fornavn":{"spoersmaal":"Fornavn","svar":"STOR"},"etternavn":{"spoersmaal":"Etternavn","svar":"SNERK"},"foedselsnummer":{"spoersmaal":"Fødselsnummer","svar":"11057523044"}},{"type":"FORELDER","fornavn":{"spoersmaal":"Fornavn","svar":"Polski"},"etternavn":{"spoersmaal":"Etternavn","svar":"Dødski"},"foedselsnummer":{"spoersmaal":"Fødselsnummer","svar":"26104500284"}}],"verge":{"spoersmaal":"Er det oppnevnt en verge for barnet?","svar":{"verdi":"JA","innhold":"Ja"},"opplysning":{"type":"VERGE","fornavn":{"spoersmaal":"Fornavn","svar":"Verg"},"etternavn":{"spoersmaal":"Etternavn","svar":"Vikernes"},"foedselsnummer":{"spoersmaal":"Fødselsnummer","svar":"30106519672"}}}}]}],"soesken":[],"versjon":"2","type":"BARNEPENSJON","mottattDato":"2023-11-30T18:05:49.337092713","template":"barnepensjon_v2"}]}"""

        val deserialized = mapper.readValue(json, jacksonTypeRef<SoeknadRequest>())

        deserialized.soeknader.size shouldBeExactly 2

        val omstillingsstoenad = deserialized.soeknader.first()
        omstillingsstoenad.type shouldBe SoeknadType.OMSTILLINGSSTOENAD
        omstillingsstoenad.template() shouldBe "omstillingsstoenad_v1"

        val barnepensjon = deserialized.soeknader.last()
        barnepensjon.type shouldBe SoeknadType.BARNEPENSJON
        barnepensjon.template() shouldBe "barnepensjon_v2"
    }

    @Test
    fun `Deserialisering av barnepensjon`() {
        val json = javaClass.getResource("/soeknad/barnepensjon.json")!!.readText()

        val soeknad = mapper.readValue<InnsendtSoeknad>(json)
        assertTrue(soeknad is Barnepensjon)
    }

    @Test
    fun `Deserialisering av barnepensjon utland`() {
        val json = javaClass.getResource("/soeknad/barnepensjon_utland.json")!!.readText()

        val soeknad = mapper.readValue<InnsendtSoeknad>(json)
        assertTrue(soeknad is Barnepensjon)
    }

    @Test
    fun `Deserialisering av omstillingsstoenad`() {
        val json = javaClass.getResource("/soeknad/omstillingsstoenad.json")!!.readText()

        val soeknad = mapper.readValue<InnsendtSoeknad>(json)
        assertTrue(soeknad is Omstillingsstoenad)
    }
}
